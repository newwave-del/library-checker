<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>송파도서관 대출 확인(실시간·배치)</title>
<style>
  :root { --fg:#111; --muted:#666; --line:#eee; }
  body { font-family: system-ui, -apple-system, sans-serif; color:var(--fg); max-width:760px; margin:24px auto; padding:0 12px; }
  h1 { font-size:20px; margin:0 0 12px; }
  .controls { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:end; }
  .grid2 { display:grid; grid-template-columns: 1fr 140px; gap:8px; }
  .muted { color:var(--muted); font-size:12px; }
  textarea { width:100%; min-height:140px; padding:8px; font-family: ui-monospace, Menlo, monospace; }
  input[type="text"] { width:100%; padding:8px; }
  button { padding:10px 14px; cursor:pointer; }
  .banner { padding:10px 12px; border-radius:8px; margin:12px 0; border:1px solid transparent; }
  .info { background:#eef6ff; border-color:#c9e1ff; }
  .error { background:#ffe8e8; border-color:#ffb2b2; }
  .success { background:#e9f8ed; border-color:#b4e3c3; }
  .row { display:grid; grid-template-columns: 1fr 110px 160px 1fr; gap:8px; padding:10px 0; border-bottom:1px solid var(--line); }
  .status { font-weight:700; }
  .small { font-size:12px; }
  details { margin:10px 0; }
  pre { white-space:pre-wrap; max-height:50vh; overflow:auto; }
</style>

<h1>송파도서관: 대출 확인(실시간·배치)</h1>

<div class="controls">
  <div>
    <div class="grid2">
      <input id="lib" type="text" value="111030" title="libCode (송파도서관)">
    </div>
    <div class="muted">OPAC 실시간만 사용. 결과는 5분 캐시.</div>
  </div>
  <button id="go">조회</button>
</div>

<div style="margin-top:8px;">
  <div class="muted small">ISBN 목록(줄바꿈 구분):</div>
  <textarea id="isbnBox">9788936434267
9791163034353</textarea>
</div>

<div id="banner"></div>
<div id="list"></div>

<details>
  <summary class="small">디버그</summary>
  <pre id="debug" class="small"></pre>
</details>

<script>
  // 네 워커 주소
  const WORKER_URL = "https://billowing-hill-990a.newwave132.workers.dev/batch";

  const $ = s => document.querySelector(s);
  const banner = $("#banner"), dbg = $("#debug");
  const show = (t,m)=>{ banner.className = `banner ${t}`; banner.textContent = m; };
  const clearBanner = ()=>{ banner.className=""; banner.textContent=""; };
  const log = (x)=>{ dbg.textContent += (dbg.textContent? "\n":"") + x; };
  const parseISBNs = raw => raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

  function render(rows){
    const box = $("#list"); box.innerHTML="";
    rows.forEach(x=>{
      const div = document.createElement("div");
      div.className = "row";
      let liveStr =
        x.statusCode === 'AVAILABLE'   ? "대출가능(실시간)" :
        x.statusCode === 'ON_HOLD'     ? "예약중(실시간)"   :
        x.statusCode === 'CHECKED_OUT' ? "대출중(실시간)"   :
        x.statusCode === 'UNAVAILABLE' ? "이용불가(실시간)" : "불명(실시간)";
      let finalStat =
        x.statusCode === 'AVAILABLE'   ? "대출가능" :
        x.statusCode === 'ON_HOLD'     ? "예약중"   :
        x.statusCode === 'CHECKED_OUT' ? "대출중"   :
        x.statusCode === 'UNAVAILABLE' ? "이용불가" : "목록없음";
      const extra = x.dueDate ? `반납예정일 ${x.dueDate}` :
                    (x.sourceUrl ? `<a href="${x.sourceUrl}" target="_blank" rel="noreferrer">OPAC바로가기</a>` : "");
      div.innerHTML = `
        <div>${x.isbn}</div>
        <div class="status">${finalStat}</div>
        <div class="small">${liveStr}${x.cached?" · 캐시":""}</div>
        <div class="small">${extra}</div>`;
      box.appendChild(div);
    });
  }

  $("#go").onclick = async () => {
    dbg.textContent=""; clearBanner();
    const lib = $("#lib").value.trim();
    const isbns = parseISBNs($("#isbnBox").value);
    if (!/^\d+$/.test(lib)) return show("error","libCode 숫자 확인.");
    if (!isbns.length) return show("error","ISBN 없음.");

    show("info", "조회 중…");
    try {
      const r = await fetch(WORKER_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ lib, isbns })
      });
      const j = await r.json();
      if (!r.ok || j.error) throw new Error(j.error || "워커 오류");
      clearBanner();
      render(j.results || []);
    } catch (e) {
      show("error", "실패: " + e.message);
      log(String(e.stack || e));
    }
  };
</script>

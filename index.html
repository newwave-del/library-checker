<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>송파도서관 대출 확인(실시간·배치·송파고정)</title>
<style>
  :root {
    --fg:#111; --muted:#666; --line:#eee;
    --ok-fg:#0a6b2b;      --ok-bg:#e8f7ee;      --ok-bd:#b7e2c7;
    --hold-fg:#8a5a00;    --hold-bg:#fff4d6;    --hold-bd:#ffe1a1;
    --out-fg:#a3122c;     --out-bg:#ffe8ec;     --out-bd:#ffc5d0;
    --unavail-fg:#555;    --unavail-bg:#f1f1f1; --unavail-bd:#ddd;
  }
  body { font-family: system-ui, -apple-system, sans-serif; color:var(--fg); max-width:760px; margin:24px auto; padding:0 12px; }
  h1 { font-size:20px; margin:0 0 12px; }
  .controls { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:end; }
  .muted { color:var(--muted); font-size:12px; }
  textarea { width:100%; min-height:140px; padding:8px; font-family: ui-monospace, Menlo, monospace; }
  button { padding:10px 14px; cursor:pointer; }
  .banner { padding:10px 12px; border-radius:8px; margin:12px 0; border:1px solid transparent; }
  .info { background:#eef6ff; border-color:#c9e1ff; }
  .error { background:#ffe8e8; border-color:#ffb2b2; }
  .success { background:#e9f8ed; border-color:#b4e3c3; }

  .row { display:grid; grid-template-columns: 1.6fr 112px 180px 1fr; gap:8px; padding:10px 0; border-bottom:1px solid var(--line); align-items:center; }
  .title { font-weight:600; }

  /* 상태 배지 색상 */
  .status { display:inline-block; padding:4px 8px; border:1px solid; border-radius:8px; font-weight:700; line-height:1; white-space:nowrap; }
  .status.ok     { color:var(--ok-fg);     background:var(--ok-bg);     border-color:var(--ok-bd); }
  .status.hold   { color:var(--hold-fg);   background:var(--hold-bg);   border-color:var(--hold-bd); }
  .status.out    { color:var(--out-fg);    background:var(--out-bg);    border-color:var(--out-bd); }
  .status.unavail{ color:var(--unavail-fg);background:var(--unavail-bg);border-color:var(--unavail-bd); }
  .small { font-size:12px; }
  details { margin:10px 0; }
  pre { white-space:pre-wrap; max-height:50vh; overflow:auto; }
</style>

<h1>송파도서관: 대출 확인(실시간·배치)</h1>

<div class="controls">
  <div class="muted">도서관 코드 <b>111030</b> 고정. 입력은 <b>ISBN 공백 제목</b> 형식.</div>
  <button id="go">조회</button>
</div>

<div style="margin-top:8px;">
  <div class="muted small">예시:</div>
  <textarea id="isbnBox">9788936434267 아몬드
9791163034353 리액트 모던 웹</textarea>
</div>

<div id="banner"></div>
<div id="list"></div>

<details>
  <summary class="small">디버그</summary>
  <pre id="debug" class="small"></pre>
</details>

<script>
  // ----- 고정 설정 -----
  const WORKER_URL = "https://billowing-hill-990a.newwave132.workers.dev/batch";
  const LIB_CODE = "111030"; // 송파 고정

  // ----- 유틸 -----
  const $ = s => document.querySelector(s);
  const banner = $("#banner"), dbg = $("#debug");
  const show = (t,m)=>{ banner.className = `banner ${t}`; banner.textContent = m; };
  const clearBanner = ()=>{ banner.className=""; banner.textContent=""; };
  const log = (x)=>{ dbg.textContent += (dbg.textContent? "\n":"") + x; };

  // "ISBN 공백 제목" → {isbn,title}
  function parseLines(raw){
    return raw.split(/\r?\n/)
      .map(s => s.trim()).filter(Boolean)
      .map(s => {
        const m = s.match(/^\s*([0-9Xx\-]{10,17})\s*(.*)$/);
        const isbnRaw = (m ? m[1] : s).trim();
        const title = (m ? m[2] : "").trim();
        const isbn = isbnRaw.replace(/[^0-9Xx]/g, "");
        return { isbn, title: title || isbn };
      })
      .filter(x => x.isbn.length >= 10);
  }

  function clsByCode(code){
    if (code === 'AVAILABLE')   return 'ok';
    if (code === 'ON_HOLD')     return 'hold';
    if (code === 'CHECKED_OUT') return 'out';
    if (code === 'UNAVAILABLE') return 'unavail';
    return 'unavail';
  }
  function textByCode(code){
    if (code === 'AVAILABLE')   return '대출가능';
    if (code === 'ON_HOLD')     return '예약중';
    if (code === 'CHECKED_OUT') return '대출중';
    if (code === 'UNAVAILABLE') return '이용불가';
    return '검색없음';
  }
  function liveDesc(code){
    if (code === 'AVAILABLE')   return '대출가능(실시간)';
    if (code === 'ON_HOLD')     return '예약중(실시간)';
    if (code === 'CHECKED_OUT') return '대출중(실시간)';
    if (code === 'UNAVAILABLE') return '이용불가(실시간)';
    return '불명(실시간)';
  }

  function render(rows){
    const box = $("#list"); box.innerHTML="";
    rows.forEach(x=>{
      const div = document.createElement("div");
      div.className = "row";
      const cls = clsByCode(x.statusCode);
      const finalText = textByCode(x.statusCode);
      const liveStr = liveDesc(x.statusCode);
      const extra = x.dueDate ? `반납예정일 ${x.dueDate}`
                  : (x.sourceUrl ? `<a href="${x.sourceUrl}" target="_blank" rel="noreferrer">OPAC바로가기</a>` : "");
      div.innerHTML = `
        <div class="title">${x.title}</div>
        <div><span class="status ${cls}">${finalText}</span></div>
        <div class="small">${liveStr}${x.cached?" · 캐시":""}</div>
        <div class="small">${extra}</div>`;
      box.appendChild(div);
    });
  }

  // ----- 실행 -----
  document.getElementById("go").onclick = async () => {
    dbg.textContent=""; clearBanner();
    const pairs = parseLines(document.getElementById("isbnBox").value);
    if (!pairs.length) return show("error","ISBN 없음.");

    show("info", "조회 중…");
    try {
      const r = await fetch(WORKER_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ lib: LIB_CODE, isbns: pairs.map(p=>p.isbn) })
      });
      const j = await r.json();
      if (!r.ok || j.error) throw new Error(j.error || "워커 오류");

      const map = new Map((j.results||[]).map(o => [o.isbn, o]));
      const rows = pairs.map(p => ({ ...(map.get(p.isbn) || { isbn:p.isbn, statusCode:"UNAVAILABLE" }), title: p.title }));

      clearBanner();
      render(rows);
    } catch(e) {
      show("error", "실패: " + e.message);
      log(String(e.stack || e));
    }
  };
</script>

<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>송파도서관 대출 가능(전일 기준)</title>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; max-width: 720px; margin: 24px auto; padding: 0 12px; }
  h1 { font-size: 20px; margin-bottom: 12px; }
  .controls { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
  .row { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 10px 0; border-bottom: 1px solid #eee; }
  .status-ok { font-weight: 700; }
  .banner { padding: 10px 12px; border-radius: 8px; margin: 12px 0; }
  .banner.error { background: #ffe8e8; border: 1px solid #ffb2b2; }
  .banner.info { background: #eef6ff; border: 1px solid #c9e1ff; }
  .banner.success { background: #e9f8ed; border: 1px solid #b4e3c3; }
  .muted { color: #666; font-size: 12px; }
  .small { font-size: 12px; }
  button { padding: 10px 14px; }
  input[type="text"] { padding: 8px; width: 100%; }
  textarea { width: 100%; min-height: 110px; padding: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  details { margin: 8px 0; }
  code { font-family: ui-monospace, Consolas, Menlo, SFMono-Regular, monospace; }
</style>

<h1>송파도서관: 대출 가능(전일 기준)</h1>

<div class="controls">
  <div>
    <div style="display:grid; grid-template-columns: 1fr 110px; gap:8px;">
      <input id="key" type="text" placeholder="data4library authKey" />
      <input id="lib" type="text" value="4720" title="libCode" />
    </div>
    <div class="muted small">※ 전일 기준 상태. 실시간 아님. 오류 시 상단 배너 확인.</div>
  </div>
  <button id="go">조회</button>
</div>

<div style="margin-top:8px;">
  <div class="muted small">ISBN 목록(줄바꿈 구분):</div>
  <textarea id="isbnBox">9788936434267
9791163034353</textarea>
</div>

<div id="banner"></div>
<div id="list"></div>

<details>
  <summary class="small">디버그 보기</summary>
  <pre id="debug" class="small" style="white-space:pre-wrap"></pre>
</details>

<script>
  // ---- 유틸
  const $ = sel => document.querySelector(sel);
  function parseISBNs(raw) { return raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean); }
  function showBanner(type, msg) { const b=$("#banner"); b.className=`banner ${type}`; b.textContent=msg; }
  function clearBanner(){ const b=$("#banner"); b.className=""; b.textContent=""; }
  function setDebug(txt){ $("#debug").textContent = txt || ""; }

  function buildBookExistURL(authKey, libCode, isbn) {
    const u = new URL("https://data4library.kr/api/bookExist");
    u.searchParams.set("authKey", authKey);
    u.searchParams.set("libCode", String(libCode));
    u.searchParams.set("isbn13", isbn);
    u.searchParams.set("format", "json");
    return u.toString();
  }
  function buildKeyProbeURL(authKey){
    // 키 검증 선행: 공개 도서관 목록 1건만 조회(키가 틀리면 거의 100% 에러를 뱉음)
    const u = new URL("https://data4library.kr/api/libSrch");
    u.searchParams.set("authKey", authKey);
    u.searchParams.set("pageNo", "1");
    u.searchParams.set("pageSize", "1");
    u.searchParams.set("format", "json");
    return u.toString();
  }

  // ---- 공통 에러 감지(키 오류/쿼터/파라미터/서버)
  function detectApiError(json){
    const resp = json?.response ?? json;
    const err = resp?.error ?? json?.error;
    if (err) {
      // {response:{error:{message, code}}} / {error:{msg}} 등
      return { isError:true, code: err.code ?? err.status ?? null, message: err.message ?? err.msg ?? err.reason ?? "API 오류" };
    }
    // 또 다른 패턴: {response:{errCode, errMsg}}
    if (typeof resp?.errCode !== "undefined" || typeof resp?.errMsg !== "undefined") {
      return { isError:true, code: resp.errCode ?? null, message: resp.errMsg ?? "API 오류" };
    }
    return { isError:false };
  }

  // ---- 키 유효성 선검사
  async function validateKey(authKey){
    let r;
    try {
      const res = await fetch(buildKeyProbeURL(authKey));
      if (res.status === 401 || res.status === 403) throw new Error("API 키 권한 오류(401/403)");
      if (res.status === 429) throw new Error("요청 과다(429)");
      if (res.status >= 500) throw new Error(`서버 오류(${res.status})`);
      r = await res.json().catch(async ()=>{
        const t = await res.text();
        throw new Error("JSON 아님/응답 형식 오류: " + t.slice(0,120));
      });
    } catch(e){
      throw e;
    }
    const e = detectApiError(r);
    if (e.isError) throw new Error(e.message || "API 오류");
    // 정상: 최소한 libs 같은 정상 구조여야 함
    const libs = r?.response?.libs ?? r?.libs;
    if (!libs) throw new Error("API 응답 비정상(키 검증 실패)");
    return true;
  }

  // ---- 단건 조회
  function extractResult(json) {
    const resp = json?.response ?? json;
    const r = resp?.result ?? resp;
    return { hasBook: r?.hasBook, loanAvailable: r?.loanAvailable };
  }

  async function fetchBookExistOnce(authKey, libCode, isbn) {
    const url = buildBookExistURL(authKey, libCode, isbn);
    let res;
    try { res = await fetch(url); }
    catch { return { isbn, error: "네트워크 오류" }; }

    if (res.status === 401 || res.status === 403) return { isbn, fatal: true, error: "API 키 권한 오류(401/403)" };
    if (res.status === 429) return { isbn, fatal: true, error: "요청 과다(429)" };
    if (res.status >= 500) return { isbn, fatal: true, error: `서버 오류(${res.status})` };

    let json;
    try { json = await res.json(); }
    catch {
      const text = await res.text();
      return { isbn, fatal: true, error: "JSON 아님/응답 형식 오류", raw: text.slice(0, 160) };
    }

    const apiErr = detectApiError(json);
    if (apiErr.isError) return { isbn, fatal: true, error: apiErr.message || "API 오류" };

    const { hasBook, loanAvailable } = extractResult(json);
    if (typeof hasBook === 'undefined' && typeof loanAvailable === 'undefined') {
      return { isbn, error: "비정상 응답(필드 누락)" };
    }
    return { isbn, hasBook, loanAvailable };
  }

  async function checkBatch(authKey, libCode, isbns) {
    const out = [];
    for (let i = 0; i < isbns.length; i++) {
      const r = await fetchBookExistOnce(authKey, libCode, isbns[i]);
      if (r.fatal) throw new Error(r.error); // 키/쿼터/서버 등은 즉시 중단
      out.push(r);
    }
    return out;
  }

  function renderRows(rows) {
    const container = $("#list");
    container.innerHTML = "";
    rows.forEach(({ isbn, hasBook, loanAvailable, error }) => {
      const div = document.createElement('div');
      div.className = "row";
      if (error) {
        div.innerHTML = `<div>${isbn}</div><div class="status-ok">오류</div><div class="small">${error}</div>`;
      } else {
        let status = '미소장';
        if (hasBook === 'Y') status = (loanAvailable === 'Y') ? '대출가능' : '대출중';
        else if (hasBook === 'N') status = '미소장';
        else status = '불명';
        div.innerHTML = `<div>${isbn}</div><div class="status-ok">${status}</div><div>${hasBook==='Y'?'📚':''}</div>`;
      }
      container.appendChild(div);
    });
  }

  // ---- 버튼 핸들러
  $("#go").onclick = async () => {
    clearBanner(); setDebug("");
    const key = $("#key").value.trim();
    const lib = $("#lib").value.trim();
    const isbns = parseISBNs($("#isbnBox").value);

    if (!key) { showBanner("error", "API 키 넣어."); return; }
    if (!/^\d+$/.test(lib)) { showBanner("error", "libCode 숫자 확인해."); return; }
    if (!isbns.length) { showBanner("error", "ISBN이 없음."); return; }

    $("#list").innerHTML = "<div class='banner info'>키 확인 중…</div>";

    try {
      await validateKey(key); // 1) 키 선검사
      showBanner("success", "API 키 확인됨. 조회 시작한다.");
    } catch(e) {
      showBanner("error", `배치 중단(키 오류/응답 이상): ${e.message}`);
      $("#list").innerHTML = "";
      setDebug(String(e.stack||e));
      return;
    }

    $("#list").innerHTML = "<div class='banner info'>ISBN 조회 중…</div>";

    try {
      const rows = await checkBatch(key, lib, isbns); // 2) 실제 조회
      clearBanner();
      renderRows(rows);
      setDebug(""); // 필요시 JSON 찍고 싶으면 여기서 rows 출력
    } catch (e) {
      showBanner("error", `배치 중단: ${e.message}`);
      $("#list").innerHTML = "";
      setDebug(String(e.stack||e));
    }
  };
</script>

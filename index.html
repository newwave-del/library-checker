
<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì†¡íŒŒë„ì„œê´€ ëŒ€ì¶œ ê°€ëŠ¥(ì „ì¼ ê¸°ì¤€)</title>
<style>
  :root { --fg:#111; --muted:#666; --line:#eee; }
  body { font-family: system-ui, -apple-system, sans-serif; color:var(--fg);
         max-width: 760px; margin: 24px auto; padding: 0 12px; }
  h1 { font-size: 20px; margin: 0 0 12px; }
  .controls { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: end; }
  .grid2 { display:grid; grid-template-columns: 1fr 120px; gap:8px; }
  .muted { color: var(--muted); font-size: 12px; }
  input[type="text"], textarea { padding: 8px; width: 100%; box-sizing: border-box; }
  textarea { min-height: 120px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  button { padding: 10px 14px; cursor: pointer; }
  .banner { padding: 10px 12px; border-radius: 8px; margin: 12px 0; border: 1px solid transparent; }
  .banner.info { background:#eef6ff; border-color:#c9e1ff; }
  .banner.error { background:#ffe8e8; border-color:#ffb2b2; }
  .banner.success { background:#e9f8ed; border-color:#b4e3c3; }
  .row { display: grid; grid-template-columns: 1fr 110px 1fr; gap: 8px;
         padding: 10px 0; border-bottom: 1px solid var(--line); }
  .status { font-weight: 700; }
  .small { font-size: 12px; }
  details { margin: 10px 0; }
  code, pre { font-family: ui-monospace, Consolas, Menlo, SFMono-Regular, monospace; }
</style>

<h1>ì†¡íŒŒë„ì„œê´€: ëŒ€ì¶œ ê°€ëŠ¥(ì „ì¼ ê¸°ì¤€)</h1>

<div class="controls">
  <div>
    <div class="grid2">
      <input id="key" type="text" placeholder="data4library authKey (ìŠ¹ì¸ í›„ ì‚¬ìš©)">
      <input id="lib" type="text" value="4720" title="libCode (ì†¡íŒŒë„ì„œê´€)">
    </div>
    <div class="muted">â€» ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€ëŠ” â€˜ì „ë‚  ê¸°ì¤€â€™ì´ì•¼. ì‹¤ì‹œê°„ ì•„ë‹˜.</div>
  </div>
  <button id="go">ì¡°íšŒ</button>
</div>

<div style="margin-top:8px;">
  <div class="muted small">ISBN ëª©ë¡(ì¤„ë°”ê¿ˆ êµ¬ë¶„):</div>
  <textarea id="isbnBox">9788936434267
9791163034353</textarea>
</div>

<div id="banner"></div>
<div id="list"></div>

<details>
  <summary class="small">ë””ë²„ê·¸ ë³´ê¸°</summary>
  <pre id="debug" class="small" style="white-space:pre-wrap; overflow:auto; max-height: 50vh;"></pre>
</details>

<script>
  // ---------- ìœ í‹¸ ----------
  const $ = s => document.querySelector(s);
  const banner = $("#banner");
  const dbg = $("#debug");

  function showBanner(type, msg){ banner.className = `banner ${type}`; banner.textContent = msg; }
  function clearBanner(){ banner.className = ""; banner.textContent = ""; }

  function setDebug(txt){ dbg.textContent = txt || ""; }
  function appendDebug(txt){
    if (!txt) return;
    dbg.textContent += (dbg.textContent ? "\n" : "") + txt;
  }
  const pretty = (obj) => JSON.stringify(obj, null, 2);

  function maskKey(k){
    if (!k) return "";
    const t = k.trim();
    return t.length > 8 ? (t.slice(0,4) + "â€¦" + t.slice(-4)) : "****";
  }
  function redactKeyInUrl(u){
    try {
      const x = new URL(u);
      if (x.searchParams.has("authKey")) x.searchParams.set("authKey", maskKey(x.searchParams.get("authKey")));
      return x.toString();
    } catch { return u; }
  }

  function parseISBNs(raw){
    return raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  }

  function detectApiError(json){
    const resp = json?.response ?? json;
    const err = resp?.error ?? json?.error;
    if (err){
      return { isError:true, code: err.code ?? err.status ?? err.errorCode ?? null,
               message: err.message ?? err.msg ?? err.reason ?? err.error ?? "API ì˜¤ë¥˜" };
    }
    if (typeof resp?.errCode !== "undefined" || typeof resp?.errMsg !== "undefined"){
      return { isError:true, code: resp.errCode ?? null, message: resp.errMsg ?? "API ì˜¤ë¥˜" };
    }
    return { isError:false };
  }

  function buildKeyProbeURL(authKey){
    const u = new URL("https://data4library.kr/api/libSrch");
    u.searchParams.set("authKey", authKey);
    u.searchParams.set("pageNo", "1");
    u.searchParams.set("pageSize", "1");
    u.searchParams.set("format", "json");
    return u.toString();
  }

  function buildBookExistURL(authKey, libCode, isbn){
    const u = new URL("https://data4library.kr/api/bookExist");
    u.searchParams.set("authKey", authKey);
    u.searchParams.set("libCode", String(libCode));
    u.searchParams.set("isbn13", isbn);
    u.searchParams.set("format", "json");
    return u.toString();
  }

  // ---------- í‚¤ ìœ íš¨ì„± ì„ ê²€ì‚¬ ----------
  async function validateKey(authKey){
    const url = buildKeyProbeURL(authKey);
    appendDebug("í‚¤ ê²€ì¦ ìš”ì²­: " + redactKeyInUrl(url));
    let res;
    try {
      res = await fetch(url);
    } catch (e) {
      appendDebug("í‚¤ ê²€ì¦ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + e.message);
      throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜(í‚¤ ê²€ì¦)");
    }
    if (res.status === 401 || res.status === 403) throw new Error("API í‚¤ ê¶Œí•œ ì˜¤ë¥˜(401/403)");
    if (res.status === 429) throw new Error("ìš”ì²­ ê³¼ë‹¤(429)");
    if (res.status >= 500) throw new Error(`ì„œë²„ ì˜¤ë¥˜(${res.status})`);

    let json;
    try {
      json = await res.json();
    } catch {
      const text = await res.text();
      appendDebug("í‚¤ ê²€ì¦ ì‘ë‹µ(ë¹„JSON):\n" + text.slice(0, 300));
      throw new Error("JSON ì•„ë‹˜/ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜(í‚¤ ê²€ì¦)");
    }

    const e = detectApiError(json);
    if (e.isError){
      appendDebug("í‚¤ ê²€ì¦ ì‘ë‹µ(ì—ëŸ¬ ë°”ë””):\n" + pretty(json));
      throw new Error(`[í‚¤ ê²€ì¦ ì‹¤íŒ¨] ${e.message}${e.code?` (code:${e.code})`:''}`);
    }

    const libs = json?.response?.libs ?? json?.libs;
    if (!libs){
      appendDebug("í‚¤ ê²€ì¦ ì‘ë‹µ(ë¹„ì •ìƒ êµ¬ì¡°):\n" + pretty(json));
      throw new Error("API ì‘ë‹µ ë¹„ì •ìƒ(í‚¤ ê²€ì¦ ì‹¤íŒ¨)");
    }
    appendDebug("í‚¤ ê²€ì¦ OK");
    return true;
  }

  // ---------- ë‹¨ê±´ ì¡°íšŒ ----------
  function extractResult(json){
    const resp = json?.response ?? json;
    const r = resp?.result ?? resp;
    return { hasBook: r?.hasBook, loanAvailable: r?.loanAvailable };
  }

  async function fetchBookExistOnce(authKey, libCode, isbn){
    const url = buildBookExistURL(authKey, libCode, isbn);
    appendDebug("bookExist ìš”ì²­: " + redactKeyInUrl(url));

    let res;
    try { res = await fetch(url); }
    catch (e) { appendDebug("bookExist ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + e.message); return { isbn, error: "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜" }; }

    if (res.status === 401 || res.status === 403) return { isbn, fatal:true, error:"API í‚¤ ê¶Œí•œ ì˜¤ë¥˜(401/403)" };
    if (res.status === 429) return { isbn, fatal:true, error:"ìš”ì²­ ê³¼ë‹¤(429)" };
    if (res.status >= 500) return { isbn, fatal:true, error:`ì„œë²„ ì˜¤ë¥˜(${res.status})` };

    let json;
    try { json = await res.json(); }
    catch {
      const text = await res.text();
      appendDebug("bookExist ì‘ë‹µ(ë¹„JSON):\n" + text.slice(0, 300));
      return { isbn, fatal:true, error:"JSON ì•„ë‹˜/ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜" };
    }

    const apiErr = detectApiError(json);
    if (apiErr.isError){
      appendDebug("bookExist ì‘ë‹µ(ì—ëŸ¬ ë°”ë””):\n" + pretty(json));
      return { isbn, fatal:true, error: `${apiErr.message}${apiErr.code?` (code:${apiErr.code})`:''}` };
    }

    const { hasBook, loanAvailable } = extractResult(json);
    if (typeof hasBook === 'undefined' && typeof loanAvailable === 'undefined'){
      appendDebug("bookExist ì‘ë‹µ(í•„ë“œ ëˆ„ë½):\n" + pretty(json));
      return { isbn, error: "ë¹„ì •ìƒ ì‘ë‹µ(í•„ë“œ ëˆ„ë½)" };
    }

    appendDebug("bookExist OK â†’ " + isbn + " : hasBook=" + hasBook + ", loanAvailable=" + loanAvailable);
    return { isbn, hasBook, loanAvailable };
  }

  async function checkBatch(authKey, libCode, isbns){
    const out = [];
    for (let i = 0; i < isbns.length; i++){
      const r = await fetchBookExistOnce(authKey, libCode, isbns[i]);
      if (r.fatal) throw new Error(r.error);
      out.push(r);
    }
    return out;
  }

  // ---------- ë Œë” ----------
  function renderRows(rows){
    const box = $("#list");
    box.innerHTML = "";
    rows.forEach(({ isbn, hasBook, loanAvailable, error }) => {
      const div = document.createElement("div");
      div.className = "row";
      if (error){
        div.innerHTML = `<div>${isbn}</div><div class="status">ì˜¤ë¥˜</div><div class="small">${error}</div>`;
      } else {
        let status = "ë¯¸ì†Œì¥";
        if (hasBook === "Y") status = (loanAvailable === "Y") ? "ëŒ€ì¶œê°€ëŠ¥" : "ëŒ€ì¶œì¤‘";
        else if (hasBook === "N") status = "ë¯¸ì†Œì¥";
        else status = "ë¶ˆëª…";
        div.innerHTML = `<div>${isbn}</div><div class="status">${status}</div><div>${hasBook==='Y'?'ğŸ“š':''}</div>`;
      }
      box.appendChild(div);
    });
  }

  // ---------- ë²„íŠ¼ ----------
  $("#go").onclick = async () => {
    clearBanner(); setDebug("");
    const key = $("#key").value.trim();
    const lib = $("#lib").value.trim();
    const isbns = parseISBNs($("#isbnBox").value);

    if (!key){ showBanner("error", "API í‚¤ ë„£ì–´."); return; }
    if (!/^\d+$/.test(lib)){ showBanner("error", "libCode ìˆ«ì í™•ì¸í•´."); return; }
    if (isbns.length === 0){ showBanner("error", "ISBNì´ ì—†ìŒ."); return; }

    $("#list").innerHTML = `<div class="banner info">í‚¤ í™•ì¸ ì¤‘â€¦ (${maskKey(key)})</div>`;

    try {
      await validateKey(key);
      showBanner("success", "API í‚¤ í™•ì¸ë¨. ì¡°íšŒ ì‹œì‘í•œë‹¤.");
    } catch (e){
      showBanner("error", `ë°°ì¹˜ ì¤‘ë‹¨(í‚¤ ì˜¤ë¥˜/ì‘ë‹µ ì´ìƒ): ${e.message}`);
      $("#list").innerHTML = "";
      return;
    }

    $("#list").innerHTML = `<div class="banner info">ISBN ì¡°íšŒ ì¤‘â€¦</div>`;

    try {
      const rows = await checkBatch(key, lib, isbns);
      clearBanner();
      renderRows(rows);
    } catch (e){
      showBanner("error", `ë°°ì¹˜ ì¤‘ë‹¨: ${e.message}`);
      $("#list").innerHTML = "";
    }
  };
</script>

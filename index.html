<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì†¡íŒŒë„ì„œê´€ ëŒ€ì¶œ ê°€ëŠ¥(ì „ì¼ ê¸°ì¤€)</title>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; max-width: 720px; margin: 24px auto; padding: 0 12px; }
  h1 { font-size: 20px; margin-bottom: 12px; }
  .controls { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
  .row { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 10px 0; border-bottom: 1px solid #eee; }
  .status-ok { font-weight: 700; }
  .banner { padding: 10px 12px; border-radius: 8px; margin: 12px 0; }
  .banner.error { background: #ffe8e8; border: 1px solid #ffb2b2; }
  .banner.info { background: #eef6ff; border: 1px solid #c9e1ff; }
  .banner.success { background: #e9f8ed; border: 1px solid #b4e3c3; }
  .muted { color: #666; font-size: 12px; }
  .small { font-size: 12px; }
  button { padding: 10px 14px; }
  input[type="text"] { padding: 8px; width: 100%; }
  textarea { width: 100%; min-height: 110px; padding: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  details { margin: 8px 0; }
  code { font-family: ui-monospace, Consolas, Menlo, SFMono-Regular, monospace; }
</style>

<h1>ì†¡íŒŒë„ì„œê´€: ëŒ€ì¶œ ê°€ëŠ¥(ì „ì¼ ê¸°ì¤€)</h1>

<div class="controls">
  <div>
    <div style="display:grid; grid-template-columns: 1fr 110px; gap:8px;">
      <input id="key" type="text" placeholder="data4library authKey" />
      <input id="lib" type="text" value="4720" title="libCode" />
    </div>
    <div class="muted small">â€» ì „ì¼ ê¸°ì¤€ ìƒíƒœ. ì‹¤ì‹œê°„ ì•„ë‹˜. ì˜¤ë¥˜ ì‹œ ìƒë‹¨ ë°°ë„ˆ í™•ì¸.</div>
  </div>
  <button id="go">ì¡°íšŒ</button>
</div>

<div style="margin-top:8px;">
  <div class="muted small">ISBN ëª©ë¡(ì¤„ë°”ê¿ˆ êµ¬ë¶„):</div>
  <textarea id="isbnBox">9788936434267
9791163034353</textarea>
</div>

<div id="banner"></div>
<div id="list"></div>

<details>
  <summary class="small">ë””ë²„ê·¸ ë³´ê¸°</summary>
  <pre id="debug" class="small" style="white-space:pre-wrap"></pre>
</details>

<script>
  // ---- ìœ í‹¸
  const $ = sel => document.querySelector(sel);
  function parseISBNs(raw) { return raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean); }
  function showBanner(type, msg) { const b=$("#banner"); b.className=`banner ${type}`; b.textContent=msg; }
  function clearBanner(){ const b=$("#banner"); b.className=""; b.textContent=""; }
  function setDebug(txt){ $("#debug").textContent = txt || ""; }

  function buildBookExistURL(authKey, libCode, isbn) {
    const u = new URL("https://data4library.kr/api/bookExist");
    u.searchParams.set("authKey", authKey);
    u.searchParams.set("libCode", String(libCode));
    u.searchParams.set("isbn13", isbn);
    u.searchParams.set("format", "json");
    return u.toString();
  }
  function buildKeyProbeURL(authKey){
    // í‚¤ ê²€ì¦ ì„ í–‰: ê³µê°œ ë„ì„œê´€ ëª©ë¡ 1ê±´ë§Œ ì¡°íšŒ(í‚¤ê°€ í‹€ë¦¬ë©´ ê±°ì˜ 100% ì—ëŸ¬ë¥¼ ë±‰ìŒ)
    const u = new URL("https://data4library.kr/api/libSrch");
    u.searchParams.set("authKey", authKey);
    u.searchParams.set("pageNo", "1");
    u.searchParams.set("pageSize", "1");
    u.searchParams.set("format", "json");
    return u.toString();
  }

  // ---- ê³µí†µ ì—ëŸ¬ ê°ì§€(í‚¤ ì˜¤ë¥˜/ì¿¼í„°/íŒŒë¼ë¯¸í„°/ì„œë²„)
  function detectApiError(json){
    const resp = json?.response ?? json;
    const err = resp?.error ?? json?.error;
    if (err) {
      // {response:{error:{message, code}}} / {error:{msg}} ë“±
      return { isError:true, code: err.code ?? err.status ?? null, message: err.message ?? err.msg ?? err.reason ?? "API ì˜¤ë¥˜" };
    }
    // ë˜ ë‹¤ë¥¸ íŒ¨í„´: {response:{errCode, errMsg}}
    if (typeof resp?.errCode !== "undefined" || typeof resp?.errMsg !== "undefined") {
      return { isError:true, code: resp.errCode ?? null, message: resp.errMsg ?? "API ì˜¤ë¥˜" };
    }
    return { isError:false };
  }

  // ---- í‚¤ ìœ íš¨ì„± ì„ ê²€ì‚¬
  async function validateKey(authKey){
    let r;
    try {
      const res = await fetch(buildKeyProbeURL(authKey));
      if (res.status === 401 || res.status === 403) throw new Error("API í‚¤ ê¶Œí•œ ì˜¤ë¥˜(401/403)");
      if (res.status === 429) throw new Error("ìš”ì²­ ê³¼ë‹¤(429)");
      if (res.status >= 500) throw new Error(`ì„œë²„ ì˜¤ë¥˜(${res.status})`);
      r = await res.json().catch(async ()=>{
        const t = await res.text();
        throw new Error("JSON ì•„ë‹˜/ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜: " + t.slice(0,120));
      });
    } catch(e){
      throw e;
    }
    const e = detectApiError(r);
    if (e.isError) throw new Error(e.message || "API ì˜¤ë¥˜");
    // ì •ìƒ: ìµœì†Œí•œ libs ê°™ì€ ì •ìƒ êµ¬ì¡°ì—¬ì•¼ í•¨
    const libs = r?.response?.libs ?? r?.libs;
    if (!libs) throw new Error("API ì‘ë‹µ ë¹„ì •ìƒ(í‚¤ ê²€ì¦ ì‹¤íŒ¨)");
    return true;
  }

  // ---- ë‹¨ê±´ ì¡°íšŒ
  function extractResult(json) {
    const resp = json?.response ?? json;
    const r = resp?.result ?? resp;
    return { hasBook: r?.hasBook, loanAvailable: r?.loanAvailable };
  }

  async function fetchBookExistOnce(authKey, libCode, isbn) {
    const url = buildBookExistURL(authKey, libCode, isbn);
    let res;
    try { res = await fetch(url); }
    catch { return { isbn, error: "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜" }; }

    if (res.status === 401 || res.status === 403) return { isbn, fatal: true, error: "API í‚¤ ê¶Œí•œ ì˜¤ë¥˜(401/403)" };
    if (res.status === 429) return { isbn, fatal: true, error: "ìš”ì²­ ê³¼ë‹¤(429)" };
    if (res.status >= 500) return { isbn, fatal: true, error: `ì„œë²„ ì˜¤ë¥˜(${res.status})` };

    let json;
    try { json = await res.json(); }
    catch {
      const text = await res.text();
      return { isbn, fatal: true, error: "JSON ì•„ë‹˜/ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜", raw: text.slice(0, 160) };
    }

    const apiErr = detectApiError(json);
    if (apiErr.isError) return { isbn, fatal: true, error: apiErr.message || "API ì˜¤ë¥˜" };

    const { hasBook, loanAvailable } = extractResult(json);
    if (typeof hasBook === 'undefined' && typeof loanAvailable === 'undefined') {
      return { isbn, error: "ë¹„ì •ìƒ ì‘ë‹µ(í•„ë“œ ëˆ„ë½)" };
    }
    return { isbn, hasBook, loanAvailable };
  }

  async function checkBatch(authKey, libCode, isbns) {
    const out = [];
    for (let i = 0; i < isbns.length; i++) {
      const r = await fetchBookExistOnce(authKey, libCode, isbns[i]);
      if (r.fatal) throw new Error(r.error); // í‚¤/ì¿¼í„°/ì„œë²„ ë“±ì€ ì¦‰ì‹œ ì¤‘ë‹¨
      out.push(r);
    }
    return out;
  }

  function renderRows(rows) {
    const container = $("#list");
    container.innerHTML = "";
    rows.forEach(({ isbn, hasBook, loanAvailable, error }) => {
      const div = document.createElement('div');
      div.className = "row";
      if (error) {
        div.innerHTML = `<div>${isbn}</div><div class="status-ok">ì˜¤ë¥˜</div><div class="small">${error}</div>`;
      } else {
        let status = 'ë¯¸ì†Œì¥';
        if (hasBook === 'Y') status = (loanAvailable === 'Y') ? 'ëŒ€ì¶œê°€ëŠ¥' : 'ëŒ€ì¶œì¤‘';
        else if (hasBook === 'N') status = 'ë¯¸ì†Œì¥';
        else status = 'ë¶ˆëª…';
        div.innerHTML = `<div>${isbn}</div><div class="status-ok">${status}</div><div>${hasBook==='Y'?'ğŸ“š':''}</div>`;
      }
      container.appendChild(div);
    });
  }

  // ---- ë²„íŠ¼ í•¸ë“¤ëŸ¬
  $("#go").onclick = async () => {
    clearBanner(); setDebug("");
    const key = $("#key").value.trim();
    const lib = $("#lib").value.trim();
    const isbns = parseISBNs($("#isbnBox").value);

    if (!key) { showBanner("error", "API í‚¤ ë„£ì–´."); return; }
    if (!/^\d+$/.test(lib)) { showBanner("error", "libCode ìˆ«ì í™•ì¸í•´."); return; }
    if (!isbns.length) { showBanner("error", "ISBNì´ ì—†ìŒ."); return; }

    $("#list").innerHTML = "<div class='banner info'>í‚¤ í™•ì¸ ì¤‘â€¦</div>";

    try {
      await validateKey(key); // 1) í‚¤ ì„ ê²€ì‚¬
      showBanner("success", "API í‚¤ í™•ì¸ë¨. ì¡°íšŒ ì‹œì‘í•œë‹¤.");
    } catch(e) {
      showBanner("error", `ë°°ì¹˜ ì¤‘ë‹¨(í‚¤ ì˜¤ë¥˜/ì‘ë‹µ ì´ìƒ): ${e.message}`);
      $("#list").innerHTML = "";
      setDebug(String(e.stack||e));
      return;
    }

    $("#list").innerHTML = "<div class='banner info'>ISBN ì¡°íšŒ ì¤‘â€¦</div>";

    try {
      const rows = await checkBatch(key, lib, isbns); // 2) ì‹¤ì œ ì¡°íšŒ
      clearBanner();
      renderRows(rows);
      setDebug(""); // í•„ìš”ì‹œ JSON ì°ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ rows ì¶œë ¥
    } catch (e) {
      showBanner("error", `ë°°ì¹˜ ì¤‘ë‹¨: ${e.message}`);
      $("#list").innerHTML = "";
      setDebug(String(e.stack||e));
    }
  };
</script>

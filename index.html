<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì†¡íŒŒë„ì„œê´€ ëŒ€ì¶œ ê°€ëŠ¥(ì „ì¼ ê¸°ì¤€)</title>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; max-width: 720px; margin: 24px auto; padding: 0 12px; }
  h1 { font-size: 20px; margin-bottom: 12px; }
  .controls { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
  .row { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 10px 0; border-bottom: 1px solid #eee; }
  .status-ok { font-weight: 700; }
  .banner { padding: 10px 12px; border-radius: 8px; margin: 12px 0; }
  .banner.error { background: #ffe8e8; border: 1px solid #ffb2b2; }
  .banner.info { background: #eef6ff; border: 1px solid #c9e1ff; }
  .muted { color: #666; font-size: 12px; }
  .small { font-size: 12px; }
  button { padding: 10px 14px; }
  input[type="text"] { padding: 8px; width: 100%; }
  textarea { width: 100%; min-height: 100px; padding: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
</style>

<h1>ì†¡íŒŒë„ì„œê´€: ëŒ€ì¶œ ê°€ëŠ¥(ì „ì¼ ê¸°ì¤€)</h1>

<div class="controls">
  <div>
    <div style="display:grid; grid-template-columns: 1fr 110px; gap:8px;">
      <input id="key" type="text" placeholder="data4library authKey" />
      <input id="lib" type="text" value="4720" title="libCode" />
    </div>
    <div class="muted small">â€» ì „ì¼ ê¸°ì¤€ ìƒíƒœ. ì‹¤ì‹œê°„ì´ ì•„ë‹˜.</div>
  </div>
  <button id="go">ì¡°íšŒ</button>
</div>

<div style="margin-top:8px;">
  <div class="muted small">ISBN ëª©ë¡(ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„):</div>
  <textarea id="isbnBox">9788936434267
9791163034353</textarea>
</div>

<div id="banner"></div>
<div id="list"></div>

<script>
  // ğŸ‘‰ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— ê¸°ë³¸ í”„ë¦¬ì…‹ ëŠ˜ë ¤ì„œ ë¶™ì—¬ë„£ì–´ë¼.
  function parseISBNs(raw) {
    return raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  }

  function buildURL(authKey, libCode, isbn) {
    const u = new URL("https://data4library.kr/api/bookExist");
    u.searchParams.set("authKey", authKey);
    u.searchParams.set("libCode", String(libCode));
    u.searchParams.set("isbn13", isbn);
    u.searchParams.set("format", "json");
    return u.toString();
  }

  // === ê³µí†µ: API ì—ëŸ¬ ê°ì§€ ===
  function detectApiError(json) {
    // ê°€ëŠ¥í•œ íŒ¨í„´ë“¤ì„ ìµœëŒ€í•œ ë³´ìˆ˜ì ìœ¼ë¡œ ì»¤ë²„
    const resp = json?.response ?? json;
    const err = resp?.error ?? json?.error;
    // ì¼€ì´ìŠ¤ 1: {response:{error:{message, code}}}
    if (err && (err.message || err.msg || err.reason || err.status)) {
      return { isError: true, code: err.code ?? err.status ?? null, message: err.message ?? err.msg ?? err.reason ?? "API ì˜¤ë¥˜" };
    }
    // ì¼€ì´ìŠ¤ 2: {error:"...", errCode:...}
    if (typeof resp?.errCode !== "undefined" || typeof resp?.errMsg !== "undefined") {
      return { isError: true, code: resp.errCode ?? null, message: resp.errMsg ?? "API ì˜¤ë¥˜" };
    }
    // ì¼€ì´ìŠ¤ 3: result ìì²´ê°€ ì—†ê³  hasBook/loanAvailableë„ ì—†ìŒ â†’ ë¹„ì •ìƒ ì‘ë‹µ
    const result = resp?.result ?? null;
    if (!result || (typeof result.hasBook === "undefined" && typeof resp.hasBook === "undefined")) {
      // ì™„ì „ ë¹„ì •ìƒì€ ì•„ë‹ˆê³  ë„ì„œ ì—†ìŒì¼ ìˆ˜ë„ ìˆì§€ë§Œ, ë³´ìˆ˜ì ìœ¼ë¡œ null ë°˜í™˜í•´ì„œ ìƒìœ„ ë¡œì§ì´ íŒë‹¨
      return { isError: false };
    }
    return { isError: false };
  }

  function extractResult(json) {
    const resp = json?.response ?? json;
    const r = resp?.result ?? resp;
    return {
      hasBook: r?.hasBook,           // 'Y' | 'N'
      loanAvailable: r?.loanAvailable // 'Y' | 'N' | undefined
    };
  }

  function showBanner(type, msg) {
    const b = document.getElementById("banner");
    b.className = `banner ${type}`;
    b.textContent = msg;
  }

  function clearBanner() {
    const b = document.getElementById("banner");
    b.className = "";
    b.textContent = "";
  }

  function renderRows(rows) {
    const container = document.getElementById('list');
    container.innerHTML = "";
    rows.forEach(({ isbn, hasBook, loanAvailable, error }) => {
      const div = document.createElement('div');
      div.className = "row";
      if (error) {
        div.innerHTML = `<div>${isbn}</div><div class="status-ok">ì˜¤ë¥˜</div><div class="small">${error}</div>`;
      } else {
        let status = 'ë¯¸ì†Œì¥';
        if (hasBook === 'Y') status = (loanAvailable === 'Y') ? 'ëŒ€ì¶œê°€ëŠ¥' : 'ëŒ€ì¶œì¤‘';
        else if (hasBook === 'N') status = 'ë¯¸ì†Œì¥';
        else if (typeof hasBook === 'undefined') status = 'ë¶ˆëª…'; // ì‘ë‹µì€ ì™”ëŠ”ë° ìŠ¤í‚¤ë§ˆê°€ ì´ìƒí•  ë•Œ
        div.innerHTML = `<div>${isbn}</div><div class="status-ok">${status}</div><div>${hasBook==='Y'?'ğŸ“š':''}</div>`;
      }
      container.appendChild(div);
    });
  }

  async function fetchBookExistOnce(authKey, libCode, isbn) {
    const url = buildURL(authKey, libCode, isbn);
    let res;
    try {
      res = await fetch(url);
    } catch (e) {
      return { isbn, error: "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜" };
    }
    if (res.status === 401 || res.status === 403) {
      return { isbn, fatal: true, error: "API í‚¤ ê¶Œí•œ ì˜¤ë¥˜(401/403)" };
    }
    if (res.status === 429) {
      return { isbn, fatal: true, error: "ìš”ì²­ ê³¼ë‹¤(429). ì ì‹œ í›„ ì¬ì‹œë„." };
    }
    if (res.status >= 500) {
      return { isbn, fatal: true, error: `ì„œë²„ ì˜¤ë¥˜(${res.status})` };
    }
    let json;
    try {
      json = await res.json();
    } catch {
      // JSON íŒŒì‹± ì‹¤íŒ¨: invalid keyì¼ ë•Œ HTML/í…ìŠ¤íŠ¸ê°€ ì˜¬ ìˆ˜ë„ ìˆìŒ
      const text = await res.text();
      return { isbn, fatal: true, error: "JSON ì•„ë‹˜/ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜", raw: text.slice(0, 120) };
    }

    // API ë‚´ë¶€ ì˜¤ë¥˜ ê°ì§€
    const e = detectApiError(json);
    if (e.isError) {
      // invalid key, quota exceeded, parameter error ë“±
      return { isbn, fatal: true, error: e.message || "API ì˜¤ë¥˜", code: e.code ?? null };
    }

    // ì •ìƒ ì¶”ì¶œ
    const { hasBook, loanAvailable } = extractResult(json);
    // ë‘ ê°’ì´ ëª¨ë‘ undefinedë©´ ë¹„ì •ìƒ ì‘ë‹µìœ¼ë¡œ ì²˜ë¦¬ (ë¯¸ì†Œì¥ìœ¼ë¡œ ì˜¤ì¸í•˜ì§€ ì•Šê²Œ)
    if (typeof hasBook === 'undefined' && typeof loanAvailable === 'undefined') {
      return { isbn, error: "ë¹„ì •ìƒ ì‘ë‹µ(í•„ë“œ ëˆ„ë½)" };
    }
    return { isbn, hasBook, loanAvailable };
  }

  async function checkBatch(authKey, libCode, isbns) {
    const out = [];
    for (let i = 0; i < isbns.length; i++) {
      const r = await fetchBookExistOnce(authKey, libCode, isbns[i]);
      if (r.fatal) {
        // í‚¤ ì˜¤ë¥˜/ì¿¼í„°/ì„œë²„ì—ëŸ¬ ë“±ì€ ì¦‰ì‹œ ë°°ì¹˜ ì¤‘ë‹¨í•˜ê³  ìƒë‹¨ ë°°ë„ˆë¡œ ì•ˆë‚´
        throw new Error(r.error);
      }
      out.push(r);
    }
    return out;
  }

  document.getElementById('go').onclick = async () => {
    clearBanner();
    const key = document.getElementById('key').value.trim();
    const lib = document.getElementById('lib').value.trim();
    const isbns = parseISBNs(document.getElementById('isbnBox').value);

    if (!key) { showBanner("error", "API í‚¤ ë„£ì–´."); return; }
    if (!lib || !/^\d+$/.test(lib)) { showBanner("error", "libCode ìˆ«ì í™•ì¸í•´."); return; }
    if (isbns.length === 0) { showBanner("error", "ISBNì´ ì—†ìŒ."); return; }

    const container = document.getElementById('list');
    container.innerHTML = "<div class='banner info'>ì¡°íšŒ ì¤‘â€¦</div>";

    try {
      const rows = await checkBatch(key, lib, isbns);
      clearBanner();
      renderRows(rows);
    } catch (e) {
      // ì—¬ê¸°ë¡œ ì˜¤ë©´ ê±°ì˜ í™•ì‹¤íˆ 'í‚¤ ë¶ˆê°€/ê¶Œí•œ/ì¿¼í„°/ì„œë²„' ë¥˜
      showBanner("error", `ë°°ì¹˜ ì¤‘ë‹¨: ${e.message}`);
      container.innerHTML = "";
    }
  };
</script>
